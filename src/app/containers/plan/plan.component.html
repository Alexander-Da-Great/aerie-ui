<app-toolbar>
  <span *ngIf="!plan">Plan</span>
  <span *ngIf="plan">Plan: {{ plan.name }}</span>

  <div class="right">
    <button
      mat-icon-button
      matTooltip="Activity Dictionary"
      (click)="showDrawerType('activityDictionary')"
    >
      <mat-icon svgIcon="activity_dictionary"></mat-icon>
    </button>
  </div>
</app-toolbar>

<as-split
  direction="horizontal"
  restrictMove="true"
  unit="pixel"
  [gutterSize]="5"
  [useTransition]="true"
  (dragEnd)="onResize()"
  (transitionEnd)="onResize()"
>
  <as-split-area size="70">
    <as-split
      #verticalSplitAreas
      direction="vertical"
      [gutterSize]="5"
      [useTransition]="true"
      (dragEnd)="tryToCollapsePanels($event)"
    >
      <as-split-area
        *ngFor="let panel of panels; trackBy: trackByPanels"
        [minSize]="panel.minSize"
        [ngClass]="{
          'panel-overflow-hidden': panel.type === 'timeline'
        }"
        [size]="panel.size"
      >
        <ng-container
          *ngTemplateOutlet="
            {
              schedule: schedule,
              simulation: simulation,
              table: table
            }[panel.template];
            context: { $implicit: panel }
          "
        ></ng-container>
      </as-split-area>
    </as-split>
  </as-split-area>

  <as-split-area
    maxSize="800"
    minSize="350"
    size="450"
    [visible]="drawerVisible"
  >
    <div [style.display]="drawer.activityDictionary.visible ? 'block' : 'none'">
      <app-panel-header>
        Activity Dictionary
      </app-panel-header>
      <div class="p-1">
        <app-placeholder *ngIf="activityTypes === null"></app-placeholder>
        <app-activity-type-list
          *ngIf="activityTypes !== null"
          [activityTypes]="activityTypes"
          (selectActivityType)="onSelectActivityType($event)"
        ></app-activity-type-list>
      </div>
    </div>

    <div
      [style.display]="drawer.createActivityInstance.visible ? 'block' : 'none'"
    >
      <app-placeholder *ngIf="activityTypes === null"></app-placeholder>
      <app-upsert-activity-instance-form
        *ngIf="activityTypes !== null"
        type="create"
        [activityTypes]="activityTypes"
        [selectedActivityType]="selectedActivityType"
        (cancel)="onCancel()"
        (create)="onCreateActivityInstance($event)"
      ></app-upsert-activity-instance-form>
    </div>

    <div
      [style.display]="
        drawer.selectedActivityInstance.visible ? 'block' : 'none'
      "
    >
      <app-upsert-activity-instance-form
        *ngIf="selectedActivityInstance; else elseBlock"
        type="update"
        [activityInstance]="selectedActivityInstance"
        [activityTypes]="activityTypes"
        (delete)="onDeleteActivityInstance($event)"
        (update)="onUpdateActivityInstance($event)"
      ></app-upsert-activity-instance-form>
      <ng-template #elseBlock>
        <mat-card>No Activity Instance Selected</mat-card>
      </ng-template>
    </div>
  </as-split-area>
</as-split>

<ng-template #schedule let-panel>
  <div *ngIf="panel.virtualSize > 1.7">
    <app-panel-header>
      Schedule
      <div class="right">
        <app-time-controls (restore)="onRestore()"></app-time-controls>
        <button class="link-icon" mat-icon-button>
          <mat-icon>link</mat-icon>
        </button>
      </div>
    </app-panel-header>
    <app-placeholder *ngIf="activityInstances === null"></app-placeholder>
    <app-timeline
      *ngIf="activityInstances !== null"
      [bands]="scheduleBands"
      [constraintViolations]="constraintViolations"
      [maxTimeRange]="maxTimeRange"
      [verticalGuides]="verticalGuides"
      [viewTimeRange]="viewTimeRange"
    ></app-timeline>
  </div>

  <app-panel-collapsed *ngIf="panel.virtualSize === 1.7">
    Schedule
  </app-panel-collapsed>
</ng-template>

<ng-template #simulation let-panel>
  <div *ngIf="panel.virtualSize > 1.7">
    <app-panel-header>
      Simulation
      <div class="right">
        <app-simulation-controls
          (run)="onSimulationRun()"
        ></app-simulation-controls>
        <app-time-controls (restore)="onRestore()"></app-time-controls>
        <button class="link-icon" mat-icon-button>
          <mat-icon>link</mat-icon>
        </button>
      </div>
    </app-panel-header>
    <app-placeholder *ngIf="simulationRunning"></app-placeholder>
    <app-panel-empty *ngIf="!simulationRunning && stateBands === null">
      Run simulation to view results
    </app-panel-empty>
    <app-timeline
      *ngIf="!simulationRunning && stateBands !== null"
      [bands]="stateBands"
      [constraintViolations]="constraintViolations"
      [maxTimeRange]="maxTimeRange"
      [verticalGuides]="verticalGuides"
      [viewTimeRange]="viewTimeRange"
    ></app-timeline>
  </div>

  <app-panel-collapsed *ngIf="panel.virtualSize === 1.7">
    Simulation
  </app-panel-collapsed>
</ng-template>

<ng-template #table let-panel>
  <div *ngIf="panel.virtualSize > 1.7">
    <app-panel-header>
      Table
    </app-panel-header>
    <app-placeholder *ngIf="activityInstances === null"></app-placeholder>
    <ng-container *ngIf="activityInstances !== null">
      <mat-card *ngIf="!activityInstances.length">
        This plan has no activity instances
      </mat-card>

      <app-activity-instances-table
        *ngIf="activityInstances.length"
        [activityInstances]="activityInstances"
        [selectedActivityInstance]="selectedActivityInstance"
        (deleteActivityInstance)="onDeleteActivityInstance($event)"
        (selectActivityInstance)="onSelectActivityInstance($event)"
      ></app-activity-instances-table>
    </ng-container>
  </div>

  <app-panel-collapsed *ngIf="panel.virtualSize === 1.7">
    Table
  </app-panel-collapsed>
</ng-template>
