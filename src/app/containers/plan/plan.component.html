<app-toolbar>
  <span *ngIf="!plan">Plan</span>
  <span *ngIf="plan">Plan: {{ plan.name }}</span>
  <span>
    <button
      class="simulation-out-of-date"
      *ngIf="simulationOutOfDate"
      mat-icon-button
      matTooltip="Simulation out of date. Click here to simulate."
      (click)="runSimulation()"
    >
      <mat-icon>error_outline</mat-icon>
    </button>
  </span>

  <div class="right">
    <button
      mat-raised-button
      class="right-button"
      [matBadge]="totalConstraintViolations"
      [matBadgeHidden]="totalConstraintViolations === 0"
      matBadgeColor="warn"
      matBadgePosition="before"
      matBadgeSize="small"
      matTooltip="Violations"
      [style.opacity]="totalConstraintViolations > 0 ? 1.0 : 0.5"
      (click)="showDrawerType('violations')"
    >
      Violations
    </button>
    <button
      mat-icon-button
      matTooltip="UI State Editor"
      (click)="showPanelEditor()"
    >
      <mat-icon svgIcon="wysiwyg"></mat-icon>
    </button>
    <button
      mat-icon-button
      matTooltip="Activity Dictionary"
      (click)="showDrawerType('activityDictionary')"
    >
      <mat-icon svgIcon="activity_dictionary"></mat-icon>
    </button>
  </div>
</app-toolbar>

<as-split
  direction="horizontal"
  restrictMove="true"
  unit="pixel"
  [gutterSize]="5"
  [useTransition]="false"
  (dragEnd)="onResize()"
  (transitionEnd)="onResize()"
>
  <as-split-area size="70">
    <as-split
      #verticalSplitAreas
      direction="vertical"
      [gutterSize]="5"
      [useTransition]="false"
    >
      <as-split-area
        *ngFor="let panel of panels; trackBy: trackByPanels; let order = index"
        [minSize]="3.2"
        [order]="order"
        [ngClass]="{
          'panel-overflow-hidden': panel.type === 'timeline'
        }"
        [size]="panel.size"
      >
        <ng-container
          *ngTemplateOutlet="
            {
              iframe: iframe,
              timeline: timeline,
              table: table
            }[panel.type];
            context: { $implicit: panel }
          "
        ></ng-container>
      </as-split-area>
    </as-split>
  </as-split-area>

  <as-split-area
    maxSize="800"
    minSize="350"
    size="450"
    [visible]="drawerVisible"
  >
    <div *ngIf="drawer.activityDictionary.visible">
      <panel-header> Activity Dictionary </panel-header>
      <div class="p-1">
        <app-placeholder *ngIf="activityTypes === null"></app-placeholder>
        <activity-type-list
          *ngIf="activityTypes !== null"
          [activityTypes]="activityTypes"
          (selectActivityType)="onSelectActivityType($event)"
        ></activity-type-list>
      </div>
    </div>

    <div *ngIf="drawer.createActivityInstance.visible">
      <app-placeholder *ngIf="activityTypes === null"></app-placeholder>
      <activity-instance-form
        *ngIf="activityTypes !== null"
        type="create"
        [activityInstancesMap]="activityInstancesMap"
        [activityTypes]="activityTypes"
        [adaptationId]="adaptationId"
        [selectedActivityType]="selectedActivityType"
        (cancel)="onCancel()"
        (create)="onCreateActivityInstance($event)"
      ></activity-instance-form>
    </div>

    <div *ngIf="drawer.panelEditor.visible">
      <panel-header> Panel Editor </panel-header>
      <form class="p-1">
        <mat-form-field class="ui-state-form-field w-100" appearance="outline">
          <mat-select
            [value]="selectedUiState?.id"
            (selectionChange)="onUiStateChanged($event)"
          >
            <mat-option *ngFor="let uiState of uiStates" [value]="uiState.id">
              {{ uiState.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </form>
      <ngx-codemirror
        [(ngModel)]="panelsText"
        [options]="panelsEditorOptions"
      ></ngx-codemirror>
    </div>

    <div *ngIf="drawer.selectedActivityInstance.visible">
      <activity-instance-form
        *ngIf="selectedActivityInstance; else elseBlock"
        type="update"
        [activityInstance]="selectedActivityInstance"
        [activityInstancesMap]="activityInstancesMap"
        [activityTypes]="activityTypes"
        [adaptationId]="adaptationId"
        (delete)="onDeleteActivityInstance($event)"
        (update)="onUpdateActivityInstance($event)"
      ></activity-instance-form>
      <ng-template #elseBlock>
        <mat-card>No Activity Instance Selected</mat-card>
      </ng-template>
    </div>

    <div *ngIf="drawer.violations.visible">
      <violation-list
        [activityInstances]="activityInstances"
        [violationListState]="constraintViolationListState"
        [violationsByCategory]="constraintViolationsByCategory"
      ></violation-list>
    </div>
  </as-split-area>
</as-split>

<ng-template #iframe let-panel>
  <panel-header>
    {{ panel.title }}
  </panel-header>
  <iframe allow="fullscreen" [src]="panel.iframe.src | safe"></iframe>
</ng-template>

<ng-template #timeline let-panel>
  <panel-header>
    {{ panel.title }}
    <div class="right">
      <button
        class="panel-menu"
        *ngIf="panel.menu"
        mat-icon-button
        [matMenuTriggerFor]="menu"
      >
        <mat-icon>more_horiz</mat-icon>
      </button>
      <mat-menu #menu="matMenu">
        <button mat-menu-item [matMenuTriggerFor]="verticalGuidesMenu">
          <mat-icon>view_column</mat-icon>
          <span>Vertical Guides</span>
        </button>
        <button
          *ngFor="let item of panel.menu"
          mat-menu-item
          (click)="onPanelMenuAction(item)"
        >
          <mat-icon>{{ item.icon }}</mat-icon>
          <span>{{ item.title }}</span>
        </button>
      </mat-menu>

      <mat-menu #verticalGuidesMenu="matMenu">
        <button
          mat-menu-item
          (click)="onCreateVerticalGuide(panel.timeline.id)"
        >
          <mat-icon>add</mat-icon>
          <span>Create New</span>
        </button>
        <button mat-menu-item [matMenuTriggerFor]="verticalGuidesEditMenu">
          <mat-icon>create</mat-icon>
          <span>Edit</span>
        </button>
        <button mat-menu-item [matMenuTriggerFor]="verticalGuidesDeleteMenu">
          <mat-icon>delete_forever</mat-icon>
          <span>Delete</span>
        </button>
      </mat-menu>

      <mat-menu #verticalGuidesEditMenu="matMenu">
        <ng-container *ngIf="!panel.timeline?.verticalGuides.length">
          <button mat-menu-item>No Vertical Guides Found</button>
        </ng-container>
        <ng-container *ngIf="panel.timeline?.verticalGuides.length">
          <button
            *ngFor="let guide of panel.timeline.verticalGuides"
            mat-menu-item
            (click)="onUpdateVerticalGuide(guide, panel.timeline.id)"
          >
            <span>{{ guide.label.text }}</span>
          </button>
        </ng-container>
      </mat-menu>

      <mat-menu #verticalGuidesDeleteMenu="matMenu">
        <ng-container *ngIf="!panel.timeline?.verticalGuides.length">
          <button mat-menu-item>No Vertical Guides Found</button>
        </ng-container>
        <ng-container *ngIf="panel.timeline?.verticalGuides.length">
          <button
            *ngFor="let guide of panel.timeline.verticalGuides"
            mat-menu-item
            (click)="onDeleteVerticalGuide(guide, panel.timeline.id)"
          >
            <span>{{ guide.label.text }}</span>
          </button>
        </ng-container>
      </mat-menu>
    </div>
  </panel-header>
  <app-placeholder *ngIf="activityInstances === null"></app-placeholder>
  <aerie-timeline
    [constraintViolations]="constraintViolations"
    [maxTimeRange]="maxTimeRange"
    [rows]="panel.timeline.rows"
    [verticalGuides]="panel.timeline.verticalGuides"
    [viewTimeRange]="viewTimeRange"
    (createHorizontalGuide)="onCreateHorizontalGuide($event)"
    (createPoint)="onCreatePoint($event)"
    (deleteHorizontalGuide)="onDeleteHorizontalGuide($event)"
    (deletePoint)="onDeletePoint($event)"
    (savePoint)="onSavePoint($event)"
    (selectPoint)="onSelectPoint($event)"
    (updateHorizontalGuide)="onUpdateHorizontalGuide($event)"
    (updatePoint)="onUpdatePoint($event)"
    (updateRow)="onUpdateRow($event)"
    (updateViewTimeRange)="onUpdateViewTimeRange($event)"
  ></aerie-timeline>
</ng-template>

<ng-template #table let-panel>
  <panel-header>
    {{ panel.title }}
  </panel-header>
  <aerie-table
    *ngIf="panel.table.type === 'activity'"
    [columns]="panel.table.columns"
    [data]="activityInstances"
    [selectedElement]="selectedActivityInstance"
    (deleteElement)="onDeleteActivityInstance($event)"
    (selectElement)="onSelectActivityInstance($event)"
  ></aerie-table>
</ng-template>
